@page "/library/import/youtube"
@rendermode InteractiveServer
@using BoxieHub.Services.Import
@using BoxieHub.Models
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@inject IImportJobService ImportJobService
@inject IYouTubeImportService YouTubeService
@inject ImportJobProcessor JobProcessor
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject ILogger<ImportYouTube> Logger
@attribute [Authorize]
@implements IDisposable

<PageTitle>Import from YouTube - BoxieHub</PageTitle>

<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/library">Library</a></li>
            <li class="breadcrumb-item active">Import from YouTube</li>
        </ol>
    </nav>

    <!-- Playlist Import Tip -->
    <div class="alert alert-info alert-dismissible fade show mb-4">
        <i class="bi bi-lightbulb"></i>
        <strong>Tip:</strong> Want to import multiple videos at once? 
        <a href="/library/import/youtube/playlist" class="alert-link">
            <i class="bi bi-collection-play"></i> Import from Playlist
        </a>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-youtube"></i> Import from YouTube
                    </h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">YouTube URL *</label>
                        <input type="text" 
                               class="form-control @(validationError != null ? "is-invalid" : "")" 
                               @bind="youtubeUrl"
                               @oninput="OnUrlChanged"
                               placeholder="https://www.youtube.com/watch?v=..."
                               disabled="@isProcessing" />
                        @if (validationError != null)
                        {
                            <div class="invalid-feedback d-block">
                                @validationError
                            </div>
                        }
                        <small class="text-muted">
                            Paste any YouTube video URL (max 90 minutes)
                        </small>
                    </div>

                    @if (isLoadingPreview)
                    {
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary"></div>
                            <p class="mt-2 text-muted">Loading video preview...</p>
                        </div>
                    }
                    else if (videoInfo != null && videoInfo.IsValid)
                    {
                        <!-- Video Preview -->
                        <div class="card mb-3 border-primary">
                            <div class="row g-0">
                                <div class="col-md-4">
                                    <img src="@videoInfo.ThumbnailUrl" 
                                         class="img-fluid rounded-start" 
                                         alt="Video thumbnail"
                                         style="max-height: 200px; object-fit: cover; width: 100%;">
                                </div>
                                <div class="col-md-8">
                                    <div class="card-body">
                                        <h5 class="card-title">@videoInfo.Title</h5>
                                        <p class="card-text small text-muted mb-2">
                                            <i class="bi bi-person"></i> @videoInfo.Author
                                        </p>
                                        <p class="card-text small mb-2">
                                            <i class="bi bi-clock"></i> Duration: @FormatDuration(videoInfo.Duration)
                                        </p>
                                        <p class="card-text small text-muted">
                                            <i class="bi bi-calendar"></i> Uploaded: @videoInfo.UploadDate.ToString("MMM dd, yyyy")
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Editable Fields -->
                        <div class="mb-3">
                            <label class="form-label">Title (editable)</label>
                            <input type="text" 
                                   class="form-control" 
                                   @bind="customTitle"
                                   maxlength="200"
                                   disabled="@isProcessing" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description (optional)</label>
                            <textarea class="form-control" 
                                      rows="3" 
                                      @bind="customDescription"
                                      maxlength="1000"
                                      disabled="@isProcessing"></textarea>
                        </div>

                        <button class="btn btn-primary btn-lg" 
                                @onclick="StartImport" 
                                disabled="@isProcessing">
                            @if (isProcessing)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span>Starting import...</span>
                            }
                            else
                            {
                                <i class="bi bi-download"></i>
                                <span>Import to Library</span>
                            }
                        </button>
                    }
                </div>
            </div>

            @if (recentJobs.Any())
            {
                <div class="card shadow-sm mt-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Imports</h5>
                    </div>
                    <div class="list-group list-group-flush">
                        @foreach (var job in recentJobs.Take(5))
                        {
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">@job.SourceTitle</h6>
                                        <small class="text-muted">
                                            @job.Created.ToString("MMM dd, yyyy h:mm tt") · 
                                            <span class="badge @GetStatusBadgeClass(job.StatusEnum)">
                                                @job.Status
                                            </span>
                                        </small>
                                    </div>
                                    @if (job.StatusEnum == ImportJobStatus.Completed && job.MediaLibraryItemId.HasValue)
                                    {
                                        <a href="/library/@job.MediaLibraryItemId" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-box-arrow-up-right"></i> View
                                        </a>
                                    }
                                </div>
                                @if (job.StatusEnum is ImportJobStatus.Downloading or ImportJobStatus.Processing or ImportJobStatus.Saving)
                                {
                                    <div class="progress mt-2" style="height: 20px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                             style="width: @(job.ProgressPercentage)%">
                                            @job.ProgressPercentage%
                                        </div>
                                    </div>
                                    <small class="text-muted">@job.StatusMessage</small>
                                }
                                @if (job.StatusEnum == ImportJobStatus.Failed)
                                {
                                    <div class="alert alert-danger mt-2 mb-0 small">
                                        <i class="bi bi-exclamation-triangle"></i> @job.ErrorMessage
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5><i class="bi bi-info-circle"></i> How it Works</h5>
                    <ol class="small">
                        <li>Paste a YouTube video URL</li>
                        <li>Preview video details</li>
                        <li>Edit title/description if needed</li>
                        <li>Click "Import to Library"</li>
                        <li>Audio will be extracted and saved</li>
                    </ol>
                    
                    <hr />
                    
                    <h6><i class="bi bi-check-circle"></i> Supported</h6>
                    <ul class="small mb-0">
                        <li>Any public YouTube video</li>
                        <li>Up to 90 minutes duration</li>
                        <li>High-quality audio (M4A)</li>
                        <li>Automatic metadata</li>
                    </ul>
                    
                    <hr />
                    
                    <h6><i class="bi bi-x-circle"></i> Not Supported</h6>
                    <ul class="small mb-0">
                        <li>Private videos</li>
                        <li>Age-restricted content</li>
                        <li>Region-blocked videos</li>
                        <li>Live streams</li>
                    </ul>

                    <hr />
                    
                    <div class="alert alert-warning small mb-0">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Legal Notice:</strong> This feature is for personal use only. 
                        Respect copyright and YouTube's Terms of Service.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string youtubeUrl = string.Empty;
    private string customTitle = string.Empty;
    private string customDescription = string.Empty;
    private YouTubeVideoInfo? videoInfo;
    private string? validationError;
    private bool isLoadingPreview;
    private bool isProcessing;
    private List<ImportJob> recentJobs = new();
    private System.Threading.Timer? debounceTimer;
    private System.Threading.Timer? pollTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadRecentJobs();
        StartPolling();
    }

    private void OnUrlChanged(ChangeEventArgs e)
    {
        youtubeUrl = e.Value?.ToString() ?? string.Empty;
        validationError = null;
        videoInfo = null;
        
        // Debounce preview loading (wait 500ms after user stops typing)
        debounceTimer?.Dispose();
        debounceTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadPreview();
                StateHasChanged();
            });
        }, null, TimeSpan.FromMilliseconds(500), Timeout.InfiniteTimeSpan);
    }

    private async Task LoadPreview()
    {
        if (string.IsNullOrWhiteSpace(youtubeUrl))
        {
            videoInfo = null;
            return;
        }
        
        isLoadingPreview = true;
        validationError = null;
        
        try
        {
            videoInfo = await YouTubeService.GetVideoInfoAsync(youtubeUrl);
            
            if (!videoInfo.IsValid)
            {
                validationError = videoInfo.ErrorMessage;
                videoInfo = null;
            }
            else
            {
                customTitle = videoInfo.Title;
                customDescription = videoInfo.Description;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load YouTube preview");
            validationError = "Failed to load video preview. Please check the URL.";
            videoInfo = null;
        }
        finally
        {
            isLoadingPreview = false;
        }
    }

    private async Task StartImport()
    {
        if (videoInfo == null || !videoInfo.IsValid)
            return;

        isProcessing = true;
        
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);

            if (string.IsNullOrEmpty(userId))
            {
                validationError = "User not authenticated";
                return;
            }

            // Create job in database
            var job = await ImportJobService.CreateYouTubeImportJobAsync(
                userId,
                youtubeUrl,
                customTitle,
                customDescription);

            // Enqueue for background processing
            await JobProcessor.EnqueueJobAsync(job.Id);

            Logger.LogInformation("Started YouTube import job {JobId}", job.Id);

            // Add to recent jobs list
            recentJobs.Insert(0, job);
            
            // Restart polling since we have a new active job
            StartPolling();

            // Clear form
            youtubeUrl = string.Empty;
            customTitle = string.Empty;
            customDescription = string.Empty;
            videoInfo = null;
            validationError = null;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to start YouTube import");
            validationError = ex.Message;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task LoadRecentJobs()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);

            if (!string.IsNullOrEmpty(userId))
            {
                recentJobs = await ImportJobService.GetUserJobsAsync(userId, take: 10);
                
                // Stop polling if there are no active jobs
                var hasActiveJobs = recentJobs.Any(j => 
                    j.StatusEnum is ImportJobStatus.Pending 
                    or ImportJobStatus.Validating 
                    or ImportJobStatus.Downloading 
                    or ImportJobStatus.Processing 
                    or ImportJobStatus.Saving);
                
                if (!hasActiveJobs && pollTimer != null)
                {
                    pollTimer.Dispose();
                    pollTimer = null;
                    Logger.LogInformation("Stopped polling - no active jobs");
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load recent jobs");
        }
    }

    private void StartPolling()
    {
        // Only start if not already polling
        if (pollTimer != null)
            return;
        
        // Poll for job updates every 2 seconds (only when there are active jobs)
        pollTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadRecentJobs();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(2), TimeSpan.FromSeconds(2));
        
        Logger.LogInformation("Started polling for job updates");
    }

    private string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalHours >= 1)
            return $"{(int)duration.TotalHours}h {duration.Minutes}m {duration.Seconds}s";
        if (duration.TotalMinutes >= 1)
            return $"{duration.Minutes}m {duration.Seconds}s";
        return $"{duration.Seconds}s";
    }

    private string GetStatusBadgeClass(ImportJobStatus status)
    {
        return status switch
        {
            ImportJobStatus.Completed => "bg-success",
            ImportJobStatus.Failed => "bg-danger",
            ImportJobStatus.Cancelled => "bg-secondary",
            ImportJobStatus.Downloading or ImportJobStatus.Processing or ImportJobStatus.Saving => "bg-primary",
            _ => "bg-warning"
        };
    }

    public void Dispose()
    {
        debounceTimer?.Dispose();
        pollTimer?.Dispose();
    }
}
