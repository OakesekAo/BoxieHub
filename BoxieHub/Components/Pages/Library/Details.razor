@rendermode InteractiveServer
@page "/library/{ItemId:int}"
@using BoxieHub.Models
@using BoxieHub.Models.BoxieCloud
@using BoxieHub.Services
@using BoxieHub.Services.Storage
@using Microsoft.AspNetCore.Authorization
@using System.ComponentModel.DataAnnotations
@attribute [Authorize]
@inject IMediaLibraryService MediaLibraryService
@inject ITonieService TonieService
@inject IFileStorageService FileStorageService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime
@inject ILogger<Details> Logger

<PageTitle>@(item?.Title ?? "Library Item") - BoxieHub</PageTitle>

<div class="container mt-4">
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading library item...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @errorMessage
        </div>
        <a href="/library" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left"></i> Back to Library
        </a>
    }
    else if (item != null)
    {
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/library">Library</a></li>
                <li class="breadcrumb-item active" aria-current="page">@item.Title</li>
            </ol>
        </nav>

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> @successMessage
                <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
            </div>
        }

        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-body">
                        @if (isEditing)
                        {
                            <EditForm Model="@editModel" OnValidSubmit="HandleSaveChanges">
                                <DataAnnotationsValidator />
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Title *</label>
                                    <InputText @bind-Value="editModel.Title" class="form-control" />
                                    <ValidationMessage For="@(() => editModel.Title)" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <InputTextArea @bind-Value="editModel.Description" class="form-control" rows="3" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Category</label>
                                    <InputSelect @bind-Value="editModel.Category" class="form-select">
                                        <option value="">-- Select Category --</option>
                                        <option value="Music">Music</option>
                                        <option value="Story">Story</option>
                                        <option value="Educational">Educational</option>
                                        <option value="Podcast">Podcast</option>
                                        <option value="Other">Other</option>
                                    </InputSelect>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Tags</label>
                                    <input type="text" 
                                           @bind="tagsInput" 
                                           @bind:event="oninput"
                                           class="form-control" 
                                           placeholder="Comma separated tags" />
                                    
                                    @if (editModel.Tags.Any())
                                    {
                                        <div class="mt-2">
                                            @foreach (var tag in editModel.Tags)
                                            {
                                                <span class="badge bg-secondary me-1">
                                                    @tag
                                                    <button type="button" class="btn-close btn-close-white ms-1" 
                                                            style="font-size: 0.6rem;"
                                                            @onclick="() => RemoveTag(tag)"></button>
                                                </span>
                                            }
                                        </div>
                                    }
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary" disabled="@isSaving">
                                        @if (isSaving)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                            <span>Saving...</span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-check-lg"></i>
                                            <span>Save Changes</span>
                                        }
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" @onclick="CancelEdit">
                                        Cancel
                                    </button>
                                </div>
                            </EditForm>
                        }
                        else
                        {
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h3>@item.Title</h3>
                                    @if (!string.IsNullOrEmpty(item.Description))
                                    {
                                        <p class="text-muted">@item.Description</p>
                                    }
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-outline-primary btn-sm" @onclick="() => isEditing = true">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" @onclick="ConfirmDelete">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            </div>

                            <!-- Metadata Grid -->
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-clock text-primary me-2"></i>
                                        <div>
                                            <small class="text-muted d-block">Duration</small>
                                            <strong>@item.FormattedDuration</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-hdd text-primary me-2"></i>
                                        <div>
                                            <small class="text-muted d-block">File Size</small>
                                            <strong>@item.FormattedFileSize</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-file-earmark-music text-primary me-2"></i>
                                        <div>
                                            <small class="text-muted d-block">Format</small>
                                            <strong>@item.ContentType</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-calendar text-primary me-2"></i>
                                        <div>
                                            <small class="text-muted d-block">Added</small>
                                            <strong>@item.Created.ToString("MMM d, yyyy")</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(item.OriginalFileName))
                            {
                                <div class="mb-3">
                                    <small class="text-muted">
                                        <i class="bi bi-file-text"></i> Original filename: @item.OriginalFileName
                                    </small>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(item.Category))
                            {
                                <div class="mb-3">
                                    <span class="badge bg-secondary">@item.Category</span>
                                </div>
                            }

                            @if (item.Tags.Any())
                            {
                                <div class="mb-3">
                                    <small class="text-muted d-block mb-2">Tags:</small>
                                    @foreach (var tag in item.Tags)
                                    {
                                        <span class="badge bg-light text-dark me-1">@tag</span>
                                    }
                                </div>
                            }
                        }
                    </div>
                </div>

                <!-- Usage History -->
                @if (item.Usages.Any())
                {
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-disc"></i> Usage History</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">This audio is currently used in the following locations:</p>
                            <div class="list-group">
                                @foreach (var usage in item.Usages.OrderByDescending(u => u.UsedAt))
                                {
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">
                                                    @if (!string.IsNullOrEmpty(usage.TonieName))
                                                    {
                                                        @usage.TonieName
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">Tonie @usage.TonieId</span>
                                                    }
                                                </h6>
                                                <p class="mb-1">
                                                    Chapter: @(usage.ChapterTitle ?? usage.ChapterId)
                                                </p>
                                                <small class="text-muted">
                                                    <i class="bi bi-calendar"></i> @usage.UsedAt.ToString("MMM d, yyyy h:mm tt")
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Statistics Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-graph-up"></i> Statistics</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Times Used</span>
                                <strong class="text-success">@item.UseCount</strong>
                            </div>
                        </div>
                        @if (item.LastUsed.HasValue)
                        {
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted">Last Used</span>
                                    <strong>@item.LastUsed.Value.ToString("MMM d, yyyy")</strong>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Actions Card -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-lightning"></i> Actions</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" @onclick="ShowTonieSelector" disabled="@isLoadingTonies">
                                @if (isLoadingTonies)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <span>Loading Tonies...</span>
                                }
                                else
                                {
                                    <i class="bi bi-plus-circle"></i>
                                    <span>Use on Tonie</span>
                                }
                            </button>
                            <button class="btn btn-outline-secondary" disabled>
                                <i class="bi bi-play-circle"></i> Preview Audio
                                <small class="d-block" style="font-size: 0.7rem;">Coming soon</small>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Tonie Selector Modal -->
@if (showTonieSelector)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-music-note-list"></i> Select a Tonie
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseTonieSelector"></button>
                </div>
                <div class="modal-body">
                    @if (isLoadingTonies)
                    {
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading your Tonies...</p>
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(tonieSelectError))
                    {
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> @tonieSelectError
                        </div>
                    }
                    else if (availableTonies.Any())
                    {
                        <p class="text-muted mb-3">
                            Select which Tonie you want to upload "@item?.Title" to:
                        </p>
                        <div class="list-group">
                            @foreach (var tonie in availableTonies)
                            {
                                <button type="button" 
                                        class="list-group-item list-group-item-action d-flex align-items-center"
                                        @onclick="() => NavigateToTonieUpload(tonie)">
                                    <img src="@tonie.ImageUrl" 
                                         alt="@tonie.Name" 
                                         class="me-3 rounded" 
                                         style="width: 60px; height: 60px; object-fit: cover;" />
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">@tonie.Name</h6>
                                        <small class="text-muted">
                                            <i class="bi bi-music-note"></i> @tonie.ChaptersPresent chapters ·
                                            <i class="bi bi-clock"></i> @FormatDuration(tonie.SecondsPresent)
                                        </small>
                                        <div class="progress mt-1" style="height: 4px;">
                                            <div class="progress-bar" 
                                                 style="width: @GetStoragePercentage(tonie)%"></div>
                                        </div>
                                    </div>
                                    <i class="bi bi-chevron-right text-muted"></i>
                                </button>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            <strong>No Tonies Found</strong>
                            <p class="mb-0 mt-2">You don't have any Creative Tonies yet, or you haven't linked your Tonie account.</p>
                        </div>
                        <div class="text-center mt-3">
                            <a href="/tonies/add-account" class="btn btn-primary">
                                <i class="bi bi-link-45deg"></i> Link Tonie Account
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirm)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle text-danger"></i> Confirm Delete</h5>
                    <button type="button" class="btn-close" @onclick="() => showDeleteConfirm = false"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete "<strong>@item?.Title</strong>" from your library?</p>
                    @if (item?.UseCount > 0)
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> 
                            <strong>Warning:</strong> This item is currently used @item.UseCount time(s) on your Tonies. 
                            Deleting it will not remove it from Tonies where it's already uploaded.
                        </div>
                    }
                    <p class="text-muted mb-0">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showDeleteConfirm = false">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-danger" @onclick="HandleDelete" disabled="@isDeleting">
                        @if (isDeleting)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>Deleting...</span>
                        }
                        else
                        {
                            <i class="bi bi-trash"></i>
                            <span>Delete</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int ItemId { get; set; }

    private MediaLibraryItem? item;
    private EditModel editModel = new();
    private string tagsInput = "";

    private bool isLoading = true;
    private bool isEditing = false;
    private bool isSaving = false;
    private bool isDeleting = false;
    private bool showDeleteConfirm = false;
    private string? errorMessage;
    private string? successMessage;
    
    // Tonie selector state
    private bool showTonieSelector = false;
    private bool isLoadingTonies = false;
    private List<CreativeTonieDto> availableTonies = new();
    private string? tonieSelectError;

    private class EditModel
    {
        [Required]
        [StringLength(200)]
        public string Title { get; set; } = string.Empty;

        [StringLength(1000)]
        public string? Description { get; set; }

        [StringLength(50)]
        public string? Category { get; set; }

        public List<string> Tags { get; set; } = new();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadItem();
    }

    private async Task LoadItem()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(userId))
            {
                errorMessage = "User not authenticated";
                return;
            }

            item = await MediaLibraryService.GetLibraryItemAsync(ItemId, userId);

            if (item == null)
            {
                errorMessage = "Library item not found";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading library item: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrWhiteSpace(tagsInput))
        {
            editModel.Tags = tagsInput
                .Split(',')
                .Select(t => t.Trim())
                .Where(t => !string.IsNullOrEmpty(t))
                .Distinct()
                .ToList();
        }
    }

    private void RemoveTag(string tag)
    {
        editModel.Tags.Remove(tag);
        tagsInput = string.Join(", ", editModel.Tags);
    }

    private void CancelEdit()
    {
        isEditing = false;
        editModel = new();
        tagsInput = "";
    }

    private async Task HandleSaveChanges()
    {
        if (item == null) return;

        isSaving = true;
        errorMessage = null;

        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(userId))
            {
                errorMessage = "User not authenticated";
                return;
            }

            var dto = new MediaLibraryItemDto
            {
                Title = editModel.Title,
                Description = editModel.Description,
                Category = editModel.Category,
                Tags = editModel.Tags
            };

            var success = await MediaLibraryService.UpdateLibraryItemAsync(ItemId, userId, dto);

            if (success)
            {
                successMessage = "Changes saved successfully!";
                isEditing = false;
                await LoadItem();
            }
            else
            {
                errorMessage = "Failed to save changes";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving changes: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void ConfirmDelete()
    {
        if (item != null)
        {
            // Populate edit model for the modal
            editModel.Title = item.Title;
            editModel.Description = item.Description;
            editModel.Category = item.Category;
            editModel.Tags = item.Tags;
            tagsInput = string.Join(", ", item.Tags);
        }
        showDeleteConfirm = true;
    }

    private async Task HandleDelete()
    {
        if (item == null) return;

        isDeleting = true;
        errorMessage = null;

        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(userId))
            {
                errorMessage = "User not authenticated";
                return;
            }

            var success = await MediaLibraryService.DeleteLibraryItemAsync(ItemId, userId);

            if (success)
            {
                // Redirect to library after successful delete
                Navigation.NavigateTo("/library");
            }
            else
            {
                errorMessage = "Failed to delete item";
                showDeleteConfirm = false;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting item: {ex.Message}";
            showDeleteConfirm = false;
        }
        finally
        {
            isDeleting = false;
        }
    }
    
    private async Task ShowTonieSelector()
    {
        showTonieSelector = true;
        isLoadingTonies = true;
        tonieSelectError = null;
        
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            
            if (string.IsNullOrEmpty(userId))
            {
                tonieSelectError = "User not authenticated";
                return;
            }
            
            var (tonies, _) = await TonieService.GetUserCreativeTonieAsync(userId);
            availableTonies = tonies;
            
            if (!availableTonies.Any())
            {
                Logger.LogInformation("No Tonies found for user {UserId}", userId);
            }
        }
        catch (Exception ex)
        {
            tonieSelectError = $"Failed to load Tonies: {ex.Message}";
            Logger.LogError(ex, "Error loading Tonies for selector");
        }
        finally
        {
            isLoadingTonies = false;
        }
    }
    
    private void CloseTonieSelector()
    {
        showTonieSelector = false;
        availableTonies.Clear();
        tonieSelectError = null;
    }
    
    private void NavigateToTonieUpload(CreativeTonieDto tonie)
    {
        // Navigate to upload page with library item ID as query parameter
        Navigation.NavigateTo($"/tonies/{tonie.HouseholdId}/{tonie.Id}/upload?fromLibrary={item?.Id}");
    }
    
    private string FormatDuration(float seconds)
    {
        var timeSpan = TimeSpan.FromSeconds(seconds);
        if (timeSpan.TotalHours >= 1)
        {
            return $"{(int)timeSpan.TotalHours}h {timeSpan.Minutes}m";
        }
        if (timeSpan.TotalMinutes >= 1)
        {
            return $"{timeSpan.Minutes}m {timeSpan.Seconds}s";
        }
        return $"{timeSpan.TotalSeconds:F1}s";
    }
    
    private int GetStoragePercentage(CreativeTonieDto tonie)
    {
        var total = tonie.SecondsPresent + tonie.SecondsRemaining;
        return total > 0 ? (int)((tonie.SecondsPresent / total) * 100) : 0;
    }
}
