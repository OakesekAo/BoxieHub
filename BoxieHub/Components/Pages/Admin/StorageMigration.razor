@rendermode InteractiveServer
@page "/admin/storage-migration"
@using BoxieHub.Services.Storage
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@inject IDatabaseToS3Migrator Migrator
@inject AuthenticationStateProvider AuthStateProvider
@inject ILogger<StorageMigration> Logger
@attribute [Authorize(Roles = "Admin")]

<PageTitle>Storage Migration - BoxieHub Admin</PageTitle>

<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item"><a href="/admin">Admin</a></li>
            <li class="breadcrumb-item active">Storage Migration</li>
        </ol>
    </nav>

    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">
                <i class="bi bi-hdd-network"></i> Database to S3 Migration
            </h3>
        </div>
        <div class="card-body">
            @if (!isLoading && !isMigrating && summary != null)
            {
                <!-- Migration Summary -->
                <div class="alert alert-info">
                    <h5><i class="bi bi-info-circle"></i> Migration Summary</h5>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="bi bi-database" style="font-size: 2rem; color: #0d6efd;"></i>
                                <h4 class="mt-2">@summary.FilesToMigrate</h4>
                                <small class="text-muted">Files in Database</small>
                                <p class="mb-0"><strong>@summary.FormattedSize</strong></p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="bi bi-cloud-check" style="font-size: 2rem; color: #198754;"></i>
                                <h4 class="mt-2">@summary.FilesAlreadyInS3</h4>
                                <small class="text-muted">Already in S3</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="bi bi-exclamation-triangle" style="font-size: 2rem; color: #ffc107;"></i>
                                <h4 class="mt-2">@summary.InconsistentFiles</h4>
                                <small class="text-muted">Inconsistent</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="bi bi-arrow-right-circle" style="font-size: 2rem; color: #6c757d;"></i>
                                <h4 class="mt-2">@(summary.FilesToMigrate + summary.InconsistentFiles)</h4>
                                <small class="text-muted">Total to Migrate</small>
                            </div>
                        </div>
                    </div>
                </div>

                @if (summary.FilesToMigrate == 0 && summary.InconsistentFiles == 0)
                {
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle-fill"></i>
                        <strong>All files are already in S3!</strong> No migration needed.
                    </div>
                }
                else
                {
                    <div class="alert alert-warning">
                        <h6><i class="bi bi-info-circle"></i> What This Will Do:</h6>
                        <ul class="mb-0">
                            <li>Upload <strong>@summary.FilesToMigrate files</strong> (@summary.FormattedSize) to MinIO S3</li>
                            <li>Update database records to point to S3 instead of Database</li>
                            <li>Clear binary data from database (saves space)</li>
                            <li>All file IDs remain the same (no foreign key issues)</li>
                            <li>Operation is <strong>safe and reversible</strong></li>
                        </ul>
                    </div>

                    <div class="alert alert-danger">
                        <h6><i class="bi bi-exclamation-triangle-fill"></i> Before You Start:</h6>
                        <ul class="mb-0">
                            <li>✅ Ensure <strong>MinIO is running</strong> at the configured URL</li>
                            <li>✅ Verify you have enough <strong>S3 storage space</strong> (@summary.FormattedSize needed)</li>
                            <li>✅ Consider backing up your database (just in case)</li>
                            <li>⚠️ Do not stop the application while migration is running</li>
                        </ul>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg" @onclick="StartMigration">
                            <i class="bi bi-play-circle"></i> Start Migration
                        </button>
                    </div>
                }
            }
            else if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading migration summary...</p>
                </div>
            }
            else if (isMigrating && result != null)
            {
                <!-- Migration in Progress -->
                <div class="text-center py-4">
                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Migrating...</span>
                    </div>
                    <h5>Migration in Progress...</h5>
                    <p class="text-muted">Please do not close this window</p>
                    
                    @if (result.TotalFiles > 0)
                    {
                        <div class="progress mt-4" style="height: 30px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: @CalculateProgress()%"
                                 aria-valuenow="@CalculateProgress()" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                @result.SuccessfulFiles / @result.TotalFiles files
                            </div>
                        </div>
                        
                        <p class="mt-3">
                            <strong>Progress:</strong> @result.SuccessfulFiles successful, @result.FailedFiles failed
                            <br />
                            <strong>Elapsed:</strong> @result.Duration.TotalSeconds.ToString("F1")s
                        </p>
                    }
                </div>
            }
            else if (result != null && result.IsComplete)
            {
                <!-- Migration Complete -->
                @if (result.IsSuccess)
                {
                    <div class="alert alert-success">
                        <h4><i class="bi bi-check-circle-fill"></i> Migration Complete!</h4>
                        <p class="mb-1">@result.Summary</p>
                        <hr />
                        <p class="mb-0">
                            <strong>All @result.SuccessfulFiles files</strong> have been successfully migrated to S3.
                            Your database has been updated and binary data cleared.
                        </p>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning">
                        <h4><i class="bi bi-exclamation-triangle-fill"></i> Migration Completed with Errors</h4>
                        <p class="mb-1">@result.Summary</p>
                        <hr />
                        <p class="mb-0">
                            <strong>Success:</strong> @result.SuccessfulFiles files migrated<br />
                            <strong>Failed:</strong> @result.FailedFiles files (see errors below)
                        </p>
                    </div>
                    
                    @if (result.Errors.Any())
                    {
                        <div class="card mt-3">
                            <div class="card-header bg-danger text-white">
                                <h6 class="mb-0">Migration Errors (@result.Errors.Count)</h6>
                            </div>
                            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>File ID</th>
                                            <th>File Name</th>
                                            <th>Error</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var error in result.Errors)
                                        {
                                            <tr>
                                                <td><code>@error.FileId</code></td>
                                                <td>@error.FileName</td>
                                                <td class="text-danger">@error.Error</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                }
                
                <div class="mt-3 d-grid">
                    <button class="btn btn-secondary" @onclick="Reset">
                        <i class="bi bi-arrow-clockwise"></i> Check Status Again
                    </button>
                </div>
            }

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger mt-3">
                    <h5><i class="bi bi-x-circle-fill"></i> Error</h5>
                    <p>@errorMessage</p>
                    @if (!string.IsNullOrEmpty(errorDetails))
                    {
                        <details class="mt-2">
                            <summary class="text-muted" style="cursor: pointer;">Technical Details</summary>
                            <pre class="mt-2 p-2 bg-light border rounded small">@errorDetails</pre>
                        </details>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Help Card -->
    <div class="card shadow mt-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-question-circle"></i> How It Works</h5>
        </div>
        <div class="card-body">
            <h6>Migration Process:</h6>
            <ol>
                <li><strong>Check S3 Connectivity</strong> - Verifies MinIO is running and accessible</li>
                <li><strong>Create/Verify Bucket</strong> - Ensures the configured bucket exists</li>
                <li><strong>Find Files</strong> - Locates all files stored in the database</li>
                <li><strong>Upload to S3</strong> - Uploads each file to MinIO with metadata</li>
                <li><strong>Update Database</strong> - Changes Provider to S3Railway and sets StoragePath</li>
                <li><strong>Clear Binary Data</strong> - Removes Data column to save space</li>
            </ol>
            
            <h6 class="mt-3">Safety Features:</h6>
            <ul>
                <li>✅ <strong>Non-destructive</strong> - Files are uploaded before database is updated</li>
                <li>✅ <strong>Verification</strong> - Each upload is verified before marking complete</li>
                <li>✅ <strong>Batch Processing</strong> - Changes saved in batches (every 10 files)</li>
                <li>✅ <strong>Error Handling</strong> - Failed files don't block the rest</li>
                <li>✅ <strong>No Downtime</strong> - App remains functional during migration</li>
            </ul>
            
            <h6 class="mt-3">After Migration:</h6>
            <ul>
                <li>All files will be served from S3 instead of database</li>
                <li>Database size will be significantly reduced</li>
                <li>New uploads will automatically go to S3 (already configured)</li>
                <li>You can delete files from S3 if needed without breaking the app</li>
            </ul>
        </div>
    </div>
</div>

@code {
    private MigrationSummary? summary;
    private MigrationResult? result;
    private bool isLoading = true;
    private bool isMigrating = false;
    private string? errorMessage;
    private string? errorDetails;

    protected override async Task OnInitializedAsync()
    {
        await LoadSummary();
    }

    private async Task LoadSummary()
    {
        isLoading = true;
        errorMessage = null;
        errorDetails = null;

        try
        {
            summary = await Migrator.GetMigrationSummaryAsync();
            Logger.LogInformation("Loaded migration summary: {FilesToMigrate} files to migrate", 
                summary.FilesToMigrate);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load migration summary: {ex.Message}";
            errorDetails = ex.ToString();
            Logger.LogError(ex, "Error loading migration summary");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task StartMigration()
    {
        if (summary == null || summary.FilesToMigrate == 0) return;

        isMigrating = true;
        errorMessage = null;
        errorDetails = null;

        try
        {
            Logger.LogInformation("Starting database to S3 migration...");
            
            // Start migration
            result = await Migrator.MigrateAllFilesAsync();
            
            Logger.LogInformation("Migration completed: {Summary}", result.Summary);
            
            // Reload summary to show updated state
            await LoadSummary();
        }
        catch (Exception ex)
        {
            errorMessage = $"Migration failed: {ex.Message}";
            errorDetails = ex.ToString();
            Logger.LogError(ex, "Migration failed with error");
        }
        finally
        {
            isMigrating = false;
        }
    }

    private async Task Reset()
    {
        result = null;
        isMigrating = false;
        await LoadSummary();
    }

    private int CalculateProgress()
    {
        if (result == null || result.TotalFiles == 0) return 0;
        return (int)((result.SuccessfulFiles + result.FailedFiles) * 100.0 / result.TotalFiles);
    }
}
