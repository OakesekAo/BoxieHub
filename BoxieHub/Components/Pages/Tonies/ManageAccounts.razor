@rendermode InteractiveServer
@page "/tonies/accounts"
@using BoxieHub.Data
@using BoxieHub.Models
@using BoxieHub.Services
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@inject ApplicationDbContext DbContext
@inject ITonieService TonieService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject ILogger<ManageAccounts> Logger
@attribute [Authorize]

<PageTitle>Manage Tonie Accounts - BoxieHub</PageTitle>

<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/tonies">My Tonies</a></li>
            <li class="breadcrumb-item active">Manage Accounts</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-person-check"></i> Manage Tonie Accounts</h2>
        <a href="/tonies/add-account" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i> Add Account
        </a>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading your accounts...</p>
        </div>
    }
    else if (credentials == null || !credentials.Any())
    {
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="bi bi-person-x" style="font-size: 4rem; color: #ccc;"></i>
                <h4 class="mt-3 text-muted">No Accounts Linked</h4>
                <p class="text-muted mb-4">
                    Add your first Tonie Cloud account to get started.
                </p>
                <a href="/tonies/add-account" class="btn btn-primary">
                    <i class="bi bi-link-45deg"></i> Link Your First Account
                </a>
            </div>
        </div>
    }
    else
    {
        <div class="card shadow">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Account</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Last Used</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var credential in credentials)
                            {
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-person-circle me-2" style="font-size: 1.8rem; color: #0d6efd;"></i>
                                            <div>
                                                <strong>@credential.DisplayName</strong>
                                                @if (credential.IsDefault)
                                                {
                                                    <br />
                                                    <span class="badge bg-success">Default</span>
                                                }
                                            </div>
                                        </div>
                                    </td>
                                    <td class="align-middle">
                                        <small class="text-muted">
                                            <i class="bi bi-envelope"></i> @credential.TonieUsername
                                        </small>
                                    </td>
                                    <td class="align-middle">
                                        @if (credential.LastAuthenticated.HasValue)
                                        {
                                            <span class="badge bg-success-subtle text-success">
                                                <i class="bi bi-check-circle-fill"></i> Active
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary-subtle text-secondary">
                                                <i class="bi bi-clock"></i> Never Used
                                            </span>
                                        }
                                    </td>
                                    <td class="align-middle">
                                        @if (credential.LastAuthenticated.HasValue)
                                        {
                                            <small class="text-muted">
                                                @credential.LastAuthenticated.Value.ToLocalTime().ToString("MMM d, yyyy 'at' h:mm tt")
                                            </small>
                                        }
                                        else
                                        {
                                            <small class="text-muted">—</small>
                                        }
                                    </td>
                                    <td class="align-middle text-end">
                                        @if (!credential.IsDefault && credentials.Count > 1)
                                        {
                                            <button class="btn btn-sm btn-outline-primary me-1" 
                                                    @onclick="() => SetDefaultAccount(credential.Id)"
                                                    disabled="@isProcessing"
                                                    title="Set as default account">
                                                <i class="bi bi-star"></i>
                                            </button>
                                        }
                                        <button class="btn btn-sm btn-outline-danger" 
                                                @onclick="() => ShowDeleteConfirmation(credential)"
                                                disabled="@isProcessing"
                                                title="Delete account">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="alert alert-info mt-4">
            <i class="bi bi-info-circle"></i>
            <strong>Tip:</strong> The default account will be used automatically when managing your Creative Tonies.
        </div>
    }

    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
            <div class="toast show" role="alert">
                <div class="toast-header @(isError ? "bg-danger text-white" : "bg-success text-white")">
                    <i class="bi @(isError ? "bi-x-circle" : "bi-check-circle") me-2"></i>
                    <strong class="me-auto">@(isError ? "Error" : "Success")</strong>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => statusMessage = null"></button>
                </div>
                <div class="toast-body">
                    @statusMessage
                </div>
            </div>
        </div>
    }
</div>

<!-- Delete Confirmation Modal -->
@if (showDeleteModal && accountToDelete != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle"></i> Confirm Deletion
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CancelDelete" disabled="@isProcessing"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Are you sure you want to remove this Tonie Cloud account?</strong></p>
                    
                    <div class="alert alert-warning mb-3">
                        <div><strong>Account:</strong> @accountToDelete.DisplayName</div>
                        <div><strong>Email:</strong> @accountToDelete.TonieUsername</div>
                    </div>

                    <div class="alert alert-danger mb-3">
                        <h6 class="alert-heading"><i class="bi bi-trash"></i> What will be deleted:</h6>
                        <ul class="mb-0">
                            <li>All <strong>households</strong> synced from this account</li>
                            <li>All <strong>Creative Tonies</strong> (characters) from those households</li>
                            <li>All cached <strong>chapter data</strong> for those Tonies</li>
                        </ul>
                    </div>

                    <div class="alert alert-info mb-3">
                        <h6 class="alert-heading"><i class="bi bi-shield-check"></i> What will be kept:</h6>
                        <ul class="mb-0">
                            <li>Your <strong>local content</strong> (uploaded audio files)</li>
                            <li>Your <strong>Tonieboxes</strong> (devices)</li>
                            <li>Your <strong>playlists and assignments</strong></li>
                        </ul>
                    </div>
                    
                    <p class="text-danger mb-0">
                        <i class="bi bi-exclamation-circle"></i> <strong>This action cannot be undone.</strong>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelDelete" disabled="@isProcessing">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmDelete" disabled="@isProcessing">
                        @if (isProcessing)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>Deleting...</span>
                        }
                        else
                        {
                            <i class="bi bi-trash me-2"></i>
                            <span>Delete Account & Synced Data</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<TonieCredential>? credentials;
    private bool isLoading = true;
    private bool isProcessing = false;
    private string? statusMessage;
    private bool isError = false;
    
    private bool showDeleteModal = false;
    private TonieCredential? accountToDelete;

    protected override async Task OnInitializedAsync()
    {
        await LoadCredentials();
    }

    private async Task LoadCredentials()
    {
        isLoading = true;
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);

            if (!string.IsNullOrEmpty(userId))
            {
                credentials = await DbContext.TonieCredentials
                    .Where(c => c.UserId == userId)
                    .OrderByDescending(c => c.IsDefault)
                    .ThenByDescending(c => c.LastAuthenticated)
                    .ToListAsync();

                Logger.LogInformation("Loaded {Count} Tonie credential(s)", credentials.Count);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading Tonie credentials");
            ShowError("Failed to load accounts");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowDeleteConfirmation(TonieCredential credential)
    {
        accountToDelete = credential;
        showDeleteModal = true;
    }

    private void CancelDelete()
    {
        showDeleteModal = false;
        accountToDelete = null;
    }

    private async Task ConfirmDelete()
    {
        if (accountToDelete == null) return;

        isProcessing = true;
        try
        {
            var credentialToDelete = await DbContext.TonieCredentials.FindAsync(accountToDelete.Id);
            if (credentialToDelete != null)
            {
                var wasDefault = credentialToDelete.IsDefault;
                var displayName = credentialToDelete.DisplayName;

                // IMPORTANT: Delete all synced Tonie data BEFORE deleting the credential
                // This removes households and creative tonies synced from this account
                Logger.LogInformation("Deleting synced Tonie data for credential '{Name}' (ID: {Id})", displayName, accountToDelete.Id);
                await TonieService.DeleteAccountDataAsync(accountToDelete.Id);

                // Now delete the credential itself
                DbContext.TonieCredentials.Remove(credentialToDelete);
                await DbContext.SaveChangesAsync();

                Logger.LogInformation("Deleted Tonie credential '{Name}' (ID: {Id})", displayName, accountToDelete.Id);

                // If deleted account was default, set another as default
                if (wasDefault)
                {
                    var authState = await AuthStateProvider.GetAuthenticationStateAsync();
                    var userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);
                    
                    var remainingCredential = await DbContext.TonieCredentials
                        .Where(c => c.UserId == userId)
                        .FirstOrDefaultAsync();

                    if (remainingCredential != null)
                    {
                        remainingCredential.IsDefault = true;
                        remainingCredential.Modified = DateTimeOffset.UtcNow;
                        await DbContext.SaveChangesAsync();
                    }
                }

                ShowSuccess($"Account '{displayName}' and all synced data deleted successfully");
                await LoadCredentials();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting Tonie credential");
            ShowError("Failed to delete account");
        }
        finally
        {
            isProcessing = false;
            showDeleteModal = false;
            accountToDelete = null;
        }
    }

    private async Task SetDefaultAccount(int credentialId)
    {
        isProcessing = true;
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);

            if (!string.IsNullOrEmpty(userId))
            {
                var allCredentials = await DbContext.TonieCredentials
                    .Where(c => c.UserId == userId)
                    .ToListAsync();

                foreach (var cred in allCredentials)
                {
                    cred.IsDefault = cred.Id == credentialId;
                    cred.Modified = DateTimeOffset.UtcNow;
                }

                await DbContext.SaveChangesAsync();

                Logger.LogInformation("Set credential {Id} as default", credentialId);

                ShowSuccess("Default account updated");
                await LoadCredentials();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error setting default account");
            ShowError("Failed to update default account");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void ShowSuccess(string message)
    {
        statusMessage = message;
        isError = false;
        StateHasChanged();
        
        Task.Delay(3000).ContinueWith(_ => 
        {
            statusMessage = null;
            InvokeAsync(StateHasChanged);
        });
    }

    private void ShowError(string message)
    {
        statusMessage = message;
        isError = true;
        StateHasChanged();
        
        Task.Delay(5000).ContinueWith(_ => 
        {
            statusMessage = null;
            InvokeAsync(StateHasChanged);
        });
    }
}