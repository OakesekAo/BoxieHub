@rendermode InteractiveServer
@using BoxieHub.Models.BoxieCloud

<div class="card shadow mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-2 text-center">
                <div class="position-relative">
                    <img src="@GetImageUrl()" alt="@Tonie.Name" class="img-fluid rounded" style="max-height: 150px;" />
                    @if (!string.IsNullOrEmpty(Tonie.ImageUrl) && Tonie.ImageUrl.StartsWith("/uploads/"))
                    {
                        <span class="badge bg-primary position-absolute top-0 start-0 m-1" title="Custom image">
                            <i class="bi bi-star-fill"></i>
                        </span>
                    }
                </div>
                <button class="btn btn-sm btn-outline-secondary mt-2 w-100" @onclick="OnChangeImageClick">
                    <i class="bi bi-image"></i> Change Image
                </button>
            </div>
            <div class="col-md-7">
                <h2 class="mb-2">@Tonie.Name</h2>
                <div class="mb-2">
                    <span class="badge bg-primary me-2">
                        <i class="bi bi-music-note"></i> @Tonie.ChaptersPresent chapters
                    </span>
                    <span class="badge bg-info me-2">
                        <i class="bi bi-clock"></i> @FormatDuration(Tonie.SecondsPresent)
                    </span>
                    @if (Tonie.Transcoding)
                    {
                        <span class="badge bg-warning">
                            <span class="spinner-border spinner-border-sm me-1"></span> Processing...
                        </span>
                    }
                    else if (Tonie.Live)
                    {
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle-fill"></i> Live
                        </span>
                    }
                </div>
                
                <!-- Storage Progress Bar -->
                <div class="mt-3">
                    <div class="d-flex justify-content-between mb-1">
                        <small class="text-muted">Storage Used</small>
                        <small class="text-muted">@GetStoragePercentage()% (@FormatDuration(Tonie.SecondsPresent) / @FormatDuration(Tonie.SecondsPresent + Tonie.SecondsRemaining))</small>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar @GetStorageColorClass()" 
                             role="progressbar" 
                             style="width: @GetStoragePercentage()%" 
                             aria-valuenow="@GetStoragePercentage()" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            @GetStoragePercentage()%
                        </div>
                    </div>
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i> @FormatDuration(Tonie.SecondsRemaining) available
                    </small>
                </div>
            </div>
            <div class="col-md-3 text-end">
                <button class="btn btn-outline-secondary mb-2 w-100" @onclick="OnRefreshClick" disabled="@IsRefreshing">
                    @if (IsRefreshing)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        <span>Refreshing...</span>
                    }
                    else
                    {
                        <i class="bi bi-arrow-clockwise"></i>
                        <span>Refresh</span>
                    }
                </button>
                <a href="@UploadUrl" class="btn btn-primary w-100">
                    <i class="bi bi-upload"></i> Upload Audio
                </a>
            </div>
        </div>
    </div>
</div>

@code {
[Parameter, EditorRequired]
public CreativeTonieDto Tonie { get; set; } = default!;

[Parameter]
public string HouseholdId { get; set; } = string.Empty;

[Parameter]
public string TonieId { get; set; } = string.Empty;

[Parameter]
public bool IsRefreshing { get; set; }

[Parameter]
public EventCallback OnRefresh { get; set; }

[Parameter]
public EventCallback OnChangeImage { get; set; }

private string UploadUrl => $"/tonies/{HouseholdId}/{TonieId}/upload";

protected override void OnParametersSet()
{
    // Force re-render when parameters change
    StateHasChanged();
}

    private Task OnRefreshClick() => OnRefresh.InvokeAsync();
    private Task OnChangeImageClick() => OnChangeImage.InvokeAsync();

    private string GetImageUrl()
    {
        if (string.IsNullOrEmpty(Tonie?.ImageUrl))
            return string.Empty;
        
        // Add timestamp to prevent browser caching
        var separator = Tonie.ImageUrl.Contains('?') ? "&" : "?";
        return $"{Tonie.ImageUrl}{separator}t={DateTime.UtcNow.Ticks}";
    }

    private string FormatDuration(float seconds)
    {
        var timeSpan = TimeSpan.FromSeconds(seconds);
        if (timeSpan.TotalHours >= 1)
        {
            return $"{(int)timeSpan.TotalHours}h {timeSpan.Minutes}m";
        }
        return $"{timeSpan.Minutes}m {timeSpan.Seconds}s";
    }

    private int GetStoragePercentage()
    {
        var total = Tonie.SecondsPresent + Tonie.SecondsRemaining;
        return total > 0 ? (int)((Tonie.SecondsPresent / total) * 100) : 0;
    }

    private string GetStorageColorClass()
    {
        var percentage = GetStoragePercentage();
        if (percentage >= 90) return "bg-danger";
        if (percentage >= 70) return "bg-warning";
        return "bg-success";
    }
}
