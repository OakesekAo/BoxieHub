@page "/tonies/add-account"
@using BoxieHub.Services.BoxieCloud
@using BoxieHub.Services
@using BoxieHub.Data
@using BoxieHub.Models
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@inject IBoxieAuthService AuthService
@inject ApplicationDbContext DbContext
@inject ICredentialEncryptionService Encryption
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Authorize]

<PageTitle>Add Tonie Account - BoxieHub</PageTitle>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="bi bi-link-45deg"></i> Link Tonie Cloud Account
                    </h3>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        Connect your Tonie Cloud account to manage your Creative Tonies through BoxieHub.
                    </p>
                    
                    <EditForm Model="@model" OnValidSubmit="SaveAccount">
                        <DataAnnotationsValidator />
                        
                        <div class="mb-3">
                            <label class="form-label">Display Name <small class="text-muted">(optional)</small></label>
                            <InputText class="form-control" @bind-Value="model.DisplayName" placeholder="e.g., Family Account" />
                            <div class="form-text">A friendly name to identify this account</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Tonie Cloud Email *</label>
                            <InputText type="email" class="form-control" @bind-Value="model.TonieUsername" placeholder="your@email.com" />
                            <ValidationMessage For="@(() => model.TonieUsername)" class="text-danger" />
                            <div class="form-text">Your email address from meine.tonies.de</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Password *</label>
                            <InputText type="password" class="form-control" @bind-Value="model.Password" placeholder="••••••••" />
                            <ValidationMessage For="@(() => model.Password)" class="text-danger" />
                            <div class="form-text">Your Tonie Cloud password (encrypted before storage)</div>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <InputCheckbox class="form-check-input" @bind-Value="model.IsDefault" id="defaultCheck" />
                            <label class="form-check-label" for="defaultCheck">
                                Set as default account
                            </label>
                            <div class="form-text">Use this account by default for managing Tonies</div>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="bi bi-exclamation-triangle-fill"></i> @errorMessage
                                <button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
                            </div>
                        }
                        
                        @if (!string.IsNullOrEmpty(successMessage))
                        {
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <i class="bi bi-check-circle-fill"></i> @successMessage
                                <button type="button" class="btn-close" @onclick="@(() => successMessage = null)"></button>
                            </div>
                        }
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" disabled="@isSaving">
                                @if (isSaving)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    <span>Testing & Saving...</span>
                                }
                                else
                                {
                                    <i class="bi bi-check-lg me-2"></i>
                                    <span>Save Account</span>
                                }
                            </button>
                            <a href="/tonies" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Cancel
                            </a>
                        </div>
                    </EditForm>
                </div>
            </div>
            
            <div class="mt-3 text-center">
                <small class="text-muted">
                    <i class="bi bi-shield-lock"></i> Your credentials are encrypted and stored securely
                </small>
            </div>
        </div>
    </div>
</div>

@code {
    private AddTonieAccountModel model = new();
    private string? errorMessage;
    private string? successMessage;
    private bool isSaving;
    
    private async Task SaveAccount()
    {
        isSaving = true;
        errorMessage = null;
        successMessage = null;
        
        try
        {
            // Step 1: Test credentials by attempting authentication
            try
            {
                await AuthService.GetAccessTokenAsync(model.TonieUsername, model.Password);
            }
            catch (Exception ex)
            {
                errorMessage = "Authentication failed. Please check your credentials and try again.";
                _logger?.LogWarning(ex, "Failed to authenticate with Tonie Cloud for {Username}", model.TonieUsername);
                return;
            }
            
            // Step 2: Get current user
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);
            
            if (string.IsNullOrEmpty(userId))
            {
                errorMessage = "User not authenticated";
                return;
            }
            
            // Step 3: If marking as default, unset other defaults
            if (model.IsDefault)
            {
                var existingDefaults = await DbContext.TonieCredentials
                    .Where(c => c.UserId == userId && c.IsDefault)
                    .ToListAsync();
                    
                foreach (var existing in existingDefaults)
                {
                    existing.IsDefault = false;
                    existing.Modified = DateTimeOffset.UtcNow;
                }
            }
            
            // Step 4: Encrypt password
            var encrypted = Encryption.Encrypt(model.Password);
            
            // Step 5: Create and save credential
            var credential = new TonieCredential
            {
                UserId = userId,
                TonieUsername = model.TonieUsername,
                EncryptedPassword = encrypted,
                DisplayName = string.IsNullOrWhiteSpace(model.DisplayName) ? model.TonieUsername : model.DisplayName,
                IsDefault = model.IsDefault,
                LastAuthenticated = DateTimeOffset.UtcNow,
                Created = DateTimeOffset.UtcNow,
                Modified = DateTimeOffset.UtcNow
            };
            
            DbContext.TonieCredentials.Add(credential);
            await DbContext.SaveChangesAsync();
            
            successMessage = "Account linked successfully!";
            
            // Redirect after short delay
            await Task.Delay(1500);
            Navigation.NavigateTo("/tonies");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to save account: {ex.Message}";
            _logger?.LogError(ex, "Error saving Tonie credential for {Username}", model.TonieUsername);
        }
        finally
        {
            isSaving = false;
        }
    }
    
    public class AddTonieAccountModel
    {
        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Please enter a valid email address")]
        public string TonieUsername { get; set; } = "";
        
        [Required(ErrorMessage = "Password is required")]
        [MinLength(6, ErrorMessage = "Password must be at least 6 characters")]
        public string Password { get; set; } = "";
        
        [StringLength(256)]
        public string? DisplayName { get; set; }
        
        public bool IsDefault { get; set; } = true;
    }
    
    private ILogger? _logger;
    
    protected override void OnInitialized()
    {
        // Get logger if available (optional, for better error tracking)
        _logger = (ILogger?)ServiceProvider?.GetService(typeof(ILogger<AddAccount>));
    }
    
    [Inject] private IServiceProvider? ServiceProvider { get; set; }
}
